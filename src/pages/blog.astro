---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";

const pageTitle = "My Astro Learning Blog";
const allPosts = await getCollection("blog");

// Group posts by module (directory)
const groupedPosts = allPosts.reduce((acc, post) => {
  const parts = post.id.split("/"); // Extract module name
  const moduleName = parts[0];

  if (!acc[moduleName]) {
    acc[moduleName] = [];
  }
  acc[moduleName].push(post);

  return acc;
}, {});

// Extract top 5 tags per module
const getTopTags = (posts) => {
  const tagCounts = posts
    .flatMap((post) => post.data.tags || [])
    .reduce((acc, tag) => {
      acc[tag] = (acc[tag] || 0) + 1;
      return acc;
    }, {});

  return Object.entries(tagCounts)
    .sort((a, b) => b[1] - a[1]) // Sort by most used tags
    .slice(0, 5)
    .map(([tag]) => tag);
};
---

<BaseLayout pageTitle={pageTitle}>
  <p>This is where I will post about my journey learning Astro.</p>
  <section class="blog-modules">
    {
      Object.entries(groupedPosts).map(([module, posts]) => {
        const sortedPosts = [...posts].sort((a, b) =>
          a.id.localeCompare(b.id, undefined, { numeric: true }),
        );

        const topTags = getTopTags(sortedPosts);
        const coverImage = `${import.meta.env.BASE_URL}/images/${module}/cover.png`; // Ensure correct path

        return (
          <details>
            <summary>
              <div class="module-header">
                <h3>
                  <a
                    href={`${import.meta.env.BASE_URL}/posts/${sortedPosts[0].id}/`}
                  >
                    {module} ({sortedPosts.length})
                  </a>
                </h3>
                <img
                  class="module-cover"
                  src={coverImage}
                  alt={`${module} cover`}
                  onError={(e) => (e.target.style.display = "none")}
                />
              </div>
            </summary>

            <div id="tag-container">
              {topTags.map((tag) => (
                <a id="tag" href={`${import.meta.env.BASE_URL}/tags/${tag}`}>
                  #{tag}
                </a>
              ))}
            </div>

            <ul>
              {sortedPosts.map((post) => {
                const postImage = `${import.meta.env.BASE_URL}/images/${module}/${post.id.split("/").pop()}.png`; // Small post image
                return (
                  <li id={post.id} class="post-item">
                    <div class="post-content">
                      <a href={`${import.meta.env.BASE_URL}/posts/${post.id}/`}>
                        {post.data.title}
                      </a>
                      <div class="post-tags">
                        {post.data.tags &&
                          post.data.tags.map((tag) => (
                            <a
                              id="tag"
                              href={`${import.meta.env.BASE_URL}/tags/${tag}`}
                            >
                              #{tag}
                            </a>
                          ))}
                      </div>
                    </div>
                    <img
                      class="post-thumbnail"
                      src={postImage}
                      alt={post.data.title}
                    />
                  </li>
                );
              })}
            </ul>
          </details>
        );
      })
    }
  </section>
</BaseLayout>

<style>
  .blog-modules {
    padding: 10px;
    max-width: 1000px;
    margin: auto;
  }

  details {
    background-color: var(--dark-bg);
    padding: 10px 20px;
    margin: 8px 0;
    border-radius: var(--radius);
    transition: all 0.3s ease-in-out;
  }

  summary {
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .module-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
  }

  .module-cover {
    margin: 0px;
    height: 200px;
    width: min-content;
    object-fit: cover;
    border-radius: var(--radius);
    margin-left: auto;
  }

  #tag-container {
    border-radius: var(--radius);
    padding: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  #tag {
    color: var(--main-bg) !important;
    padding: 1px 10px;
    font-size: 13px;
    font-weight: 600;
    background: var(--accent);
    border-radius: 9999px;
  }

  .post-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-radius: var(--radius);
    background: var(--main-bg);
    margin: 20px;
    padding: 20px;
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 5px;
  }

  .post-thumbnail {
    margin: 0px;
    height: 200px;
    object-fit: cover;
    border-radius: var(--radius);
  }
</style>
